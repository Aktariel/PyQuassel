<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=1" />
    </head>
    <body>
        <div id="content">
            <div id="chatlist">
                {% for networkId, bufferIdList in chatList %}
                    <div class="network">
                        <h1>{{ networks[networkId]['name'] }}</h1>
                        
                        {% for bufferId in bufferIdList %}
                        <div class="buffer">
                            <h2 id="buffer-{{ bufferId }}">{{ buffers[bufferId]['name'] }}</h2>
                            <div class="bufferview">
                                <div id="buffer-{{ bufferId }}-messages" class="buffer-messages">
                                    {% for message in buffers[bufferId]['messages'] %}
                                        <div class="message">
                                            <span class="timestamp"><time data-epoch="{{ message['timestamp']}}" /></span>
                                            <span class="sender">{{ message['sender'] }}</span>
                                            <span class="content">{{ message['content'] }}</span>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <div class="bufferview">
                {% for bufferId, buffer in buffers.items() %}
                
                {% endfor %}
            </div>
            <div class="userinput"></div>
        </div>

        <script>
            function formatDates() {
                Array.prototype.forEach.call(document.querySelectorAll('time'), function(e) {
                    var d = new Date(e.getAttribute('data-epoch')*1000);
                    var tokens = d.toTimeString().split(':');
                    e.innerText = tokens[0] +':' + tokens[1];
                });
            }
            function formatContent() {
                // http://stackoverflow.com/questions/3809401/what-is-a-good-regular-expression-to-match-a-url
                var urlRegex = /(https?:\/\/[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*))/;
                Array.prototype.forEach.call(document.querySelectorAll('.message .content'), function(e) {
                    e.innerHTML = e.innerHTML.replace(urlRegex, '<a href="$1">$1</a>');
                });
            }
            function formatMessages() {
                formatDates();
                formatContent();
            }

            function update() {
                if (document.activeElement && document.activeElement.tagName === 'INPUT')
                    return;
                
                var xhr = new XMLHttpRequest();
                xhr.open('GET', '/', true);

                xhr.onload = function() {
                  if (this.status == 200) {
                    var html =  this.responseText;

                    var parser = new DOMParser();
                    var doc = parser.parseFromString(html, 'text/html');
                    console.log(doc);
                    window.doc = doc;

                    document.querySelector('#content').innerHTML = doc.querySelector('#content').innerHTML;
                    formatMessages();
                  }
                };
                xhr.send();
            }
            setInterval(update, 30000);
            formatMessages();
        </script>
        <style>
            .bufferview {
                display: table;
            }
            .buffer-messages {
                display: table-row;
            }
            .message {
                display: table-row;
            }
            .message > * {
                display: table-cell;
                font-family: Consolas;
                vertical-align: top;
                padding: 0 0.5em;
            }
            .message .timestamp {
                color: #444;
            }
            .message .sender {
                font-weight: bold;
                text-align: right;
            }
            .message .content {
                word-break: break-word;
            }
            form > div {
                display: table;
                width: 100%;
            }
            form input[type="text"] {
                display: table-cell;
                width: calc(100% - 60px);
            }
            form input[type="submit"] {
                display: table-cell;
                width: 60px;
            }

            @media (min-width: 1px) and (max-width: 768px) {
                .buffer-messages,
                .message {
                    /*display: block;*/
                }
                .message > * {
                    /*display: inline;*/
                }
                .message .timestamp {
                    display: none;
                }
            }
        </style>

    </body>
</html>